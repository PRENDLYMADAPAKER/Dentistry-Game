<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dental Hub ‚Äî Final Fixed Edition ü¶∑</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent: #1eaedb;
      --accent-2: #3aa0ff;
      --muted: #6b7280;
      --text: #04202a;
      --glass-blur: 12px;
      --card-shadow: 0 12px 40px rgba(16,24,40,0.06);
      --success: #0b8f6b;
      --danger: #b73636;
      --timer-green: linear-gradient(90deg,#1eaedb,#3aa0ff);
      --overlay-bg: rgba(255,255,255,0.98);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      background: linear-gradient(130deg, rgba(243,249,255,0.85), rgba(247,250,255,0.9));
      overflow: hidden; /* avoid scroll when overlay visible */
    }

    /* animated radial floating blobs */
    body::before, body::after {
      content:""; position:fixed; inset:-20%; z-index:-2; filter:blur(80px); opacity:.95; pointer-events:none;
    }
    body::before{ background: radial-gradient(circle at 10% 20%, rgba(46,199,255,0.14), transparent 10%), radial-gradient(circle at 80% 80%, rgba(147,196,255,0.12), transparent 10%); animation: floatA 18s ease-in-out infinite; }
    body::after { background: radial-gradient(circle at 60% 10%, rgba(255,240,220,0.08), transparent 15%), radial-gradient(circle at 20% 85%, rgba(220,245,255,0.06), transparent 15%); animation: floatB 22s ease-in-out infinite; }
    @keyframes floatA { 0%{transform:translate(-3%,-2%) scale(1)}50%{transform:translate(3%,2%) scale(1.02)}100%{transform:translate(-3%,-2%) scale(1)} }
    @keyframes floatB { 0%{transform:translate(4%,-1%) scale(1)}50%{transform:translate(-4%,1%) scale(1.03)}100%{transform:translate(4%,-1%) scale(1)} }

    .scene { width:100%; max-width:1100px; display:grid; grid-template-columns:360px 1fr; gap:28px; align-items:start; }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.78), rgba(250,250,255,0.66));
      border-radius:16px; padding:20px; border:1px solid rgba(255,255,255,0.6);
      backdrop-filter: blur(var(--glass-blur)); box-shadow:var(--card-shadow);
      height: calc(100vh - 56px);
      overflow:auto;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:56px;height:56px;border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px; box-shadow:0 8px 24px rgba(30,174,219,0.18); }
    .title{ font-size:20px; font-weight:700; color:var(--text); }
    .subtitle{ font-size:13px; color:var(--muted); margin-top:4px; }

    .menu{ margin-top:18px; display:flex; flex-direction:column; gap:12px; }
    .menu button{
      background: linear-gradient(180deg, rgba(255,255,255,0.94), rgba(255,255,255,0.86));
      border-radius:12px; padding:14px 16px; border:1px solid rgba(10,20,30,0.04);
      display:flex; align-items:center; justify-content:space-between; cursor:pointer; font-weight:700; color:var(--text);
      transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s;
      box-shadow: 0 6px 20px rgba(16,24,40,0.05);
      position:relative; overflow:hidden;
    }
    .menu button:hover{ transform: translateY(-6px); box-shadow: 0 22px 48px rgba(16,24,40,0.08); }

    /* ripple */
    .ripple { position:absolute; border-radius:50%; transform:scale(0); animation:ripple .6s linear; background: rgba(30,174,219,0.14); pointer-events:none; }
    @keyframes ripple { to { transform:scale(4); opacity:0; } }

    .emoji{ font-size:18px; width:34px; text-align:center; }

    .controls { display:flex; gap:10px; align-items:center; margin-left:auto; }
    .control-btn { width:44px; height:44px; border-radius:10px; border:1px solid rgba(7,17,27,0.04); background:rgba(255,255,255,0.92); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 8px 20px rgba(16,24,40,0.05); }

    .main { display:flex; flex-direction:column; gap:18px; }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.82));
      border-radius:14px; padding:20px; border:1px solid rgba(255,255,255,0.7); backdrop-filter: blur(var(--glass-blur));
      box-shadow:var(--card-shadow); transition: transform .18s cubic-bezier(.2,.9,.3,1), opacity .18s;
      position:relative; overflow:hidden;
      min-height:180px;
    }

    .game-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .game-title{ font-weight:700; font-size:18px; color:var(--text); }
    .game-sub{ color:var(--muted); font-size:13px; }

    /* Wordscape */
    .word-area{ display:flex; flex-direction:column; gap:12px; align-items:center; padding-top:6px; }
    #word-display{ font-size:26px; letter-spacing:8px; font-weight:700; color:var(--text); background:linear-gradient(90deg, rgba(30,174,219,0.06), rgba(58,160,255,0.04)); padding:12px 18px; border-radius:12px; min-width:220px; text-align:center; }
    #letters-container{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:6px; }
    #letters-container button{
      width:60px;height:60px;border-radius:12px;border:none;background:white;font-size:18px; box-shadow:0 10px 26px rgba(16,24,40,0.06);
      cursor:pointer; font-weight:800; color:var(--text); transition: transform .12s ease, box-shadow .12s ease;
    }
    #letters-container button:active{ transform:scale(.98) }
    #letters-container button:disabled{ opacity:.28; cursor:default; transform:scale(.98) }

    .info-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:6px; width:100%; max-width:700px; }
    .score-pill{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; padding:8px 12px; border-radius:999px; font-weight:800; }

    /* Options (Quiz / Case) */
    .options{ display:flex; flex-direction:column; gap:10px; margin-top:10px; max-height:320px; overflow:auto; padding-right:6px; }
    .option-btn{
      padding:14px 16px; border-radius:10px; border:1px solid rgba(7,17,27,0.03);
      background:white; color:var(--text); font-weight:800; cursor:pointer; box-shadow:0 10px 30px rgba(16,24,40,0.05);
      transition: transform .12s cubic-bezier(.2,.9,.3,1), box-shadow .12s;
    }
    .option-btn:hover{ transform: translateY(-6px); box-shadow: 0 22px 40px rgba(16,24,40,0.08); }
    .option-btn:disabled{ opacity:.5; cursor:default; transform:none; }

    .feedback{ min-height:24px; margin-top:10px; font-weight:700; color:var(--muted); }

    /* Timer bar */
    .timer-wrap{ height:8px; background:rgba(10,20,30,0.04); border-radius:999px; overflow:hidden; margin-top:12px; }
    .timer-bar{ height:100%; width:100%; background:var(--timer-green); transition:width .2s linear; transform-origin:left; }

    .small{ font-size:13px; color:var(--muted); margin-top:10px; }

    /* Overlay (page transition) */
    .overlay {
      position:fixed; inset:0; z-index:60; display:flex; align-items:flex-start; justify-content:center;
      background: rgba(255,255,255,0.0); pointer-events:none;
    }
    .overlay-panel {
      margin-top:36px;
      width: min(920px, calc(100% - 48px));
      max-height: calc(100vh - 72px);
      background: var(--overlay-bg);
      border-radius:14px;
      box-shadow: 0 30px 80px rgba(10,20,30,0.12);
      border:1px solid rgba(0,0,0,0.04);
      transform: translateX(40px) scale(.98);
      opacity:0;
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease;
      pointer-events:auto;
      overflow:auto;
    }
    .overlay.show .overlay-panel { transform: translateX(0) scale(1); opacity:1; }

    .overlay-hide { opacity:0; transition: opacity .18s ease; }

    .home-btn {
      position: absolute; left:12px; top:12px; z-index:5;
      width:44px;height:44px;border-radius:10px;border:1px solid rgba(7,17,27,0.04); background:rgba(255,255,255,0.95); display:flex;align-items:center;justify-content:center; cursor:pointer;
      box-shadow:0 10px 26px rgba(16,24,40,0.06);
    }

    @media (max-width:1000px){ .scene{ grid-template-columns: 1fr; max-width:680px; } .panel{ height: auto; } .overlay-panel{ width: calc(100% - 32px); margin-top:18px; } }
    @media (max-width:420px){ body{ padding:14px } #word-display{ font-size:20px; letter-spacing:6px } .logo{ width:48px;height:48px;font-size:16px } }
  </style>
</head>
<body>
  <div class="scene" aria-live="polite">
    <!-- Left Panel (menu) -->
    <aside class="panel" aria-label="Game menu">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="brand">
          <div class="logo">DH</div>
          <div>
            <div class="title">Dental Hub</div>
            <div class="subtitle">Learn ‚Ä¢ Diagnose ‚Ä¢ Practice</div>
          </div>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <div class="controls">
            <button id="muteBtn" class="control-btn" title="Mute / Unmute" aria-pressed="false" onclick="toggleMute()">
              <svg id="muteIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 5L6 9H2v6h4l5 4V5z" fill="#06202b"/>
                <path d="M19 8l-1.41 1.41L20.17 12l-2.58 2.59L19 16l3-3-3-5z" fill="#7a8a94"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="menu" role="navigation" aria-label="Choose game" id="menuButtons">
        <button onclick="ripple(this); openOverlay('wordscape'); playTone('click')">
          <span class="label"><span class="emoji">üß©</span> Dental Wordscape</span>
          <span style="font-size:13px;color:var(--muted)">Connect letters ‚Ä¢ Vocabulary</span>
        </button>

        <button onclick="ripple(this); openOverlay('quiz'); playTone('click')">
          <span class="label"><span class="emoji">üìò</span> Dental Quiz Game</span>
          <span style="font-size:13px;color:var(--muted)">Multiple choice ‚Ä¢ Timed</span>
        </button>

        <button onclick="ripple(this); openOverlay('case'); playTone('click')">
          <span class="label"><span class="emoji">üí¨</span> Case Challenge</span>
          <span style="font-size:13px;color:var(--muted)">Clinical scenarios</span>
        </button>
      </div>

      <div class="small" style="margin-top:14px">Data source: <strong>GitHub JSON</strong> ‚Äî edit files to update content.</div>
      <div class="small" style="margin-top:8px">High scores stored locally in your browser. Use Home (üè†) to return to menu.</div>
    </aside>

    <!-- Right content: small preview cards (optional) -->
    <main class="main" style="max-height: calc(100vh - 56px); overflow:auto;">
      <!-- Preview: Wordscape -->
      <section class="card">
        <div class="game-header">
          <div><div class="game-title">üß© Dental Wordscape</div><div class="game-sub">Form dental terms by tapping letters</div></div>
          <div class="game-sub" id="word-high">üèÜ High Score: 0</div>
        </div>
        <div style="margin-top:14px;">
          <div id="preview-word" style="font-weight:700;color:var(--muted)">Preview: Tap to open full Wordscape</div>
          <div style="margin-top:12px;"><button class="option-btn" onclick="openOverlay('wordscape'); playTone('click')">Open Wordscape</button></div>
        </div>
      </section>

      <!-- Preview: Quiz -->
      <section class="card">
        <div class="game-header">
          <div><div class="game-title">üìò Dental Quiz</div><div class="game-sub">Answer quickly ‚Äî 15s per question</div></div>
          <div class="game-sub" id="quiz-high">üèÜ High Score: 0</div>
        </div>
        <div style="margin-top:12px;">
          <div id="preview-quiz" style="font-weight:700;color:var(--muted)">Preview: Timed quiz with auto-next</div>
          <div style="margin-top:12px;"><button class="option-btn" onclick="openOverlay('quiz'); playTone('click')">Open Quiz</button></div>
        </div>
      </section>

      <!-- Preview: Case -->
      <section class="card">
        <div class="game-header">
          <div><div class="game-title">üí¨ Case Challenge</div><div class="game-sub">Clinical scenarios</div></div>
          <div class="game-sub" id="case-high">üèÜ High Score: 0</div>
        </div>
        <div style="margin-top:12px;">
          <div id="preview-case" style="font-weight:700;color:var(--muted)">Preview: Practice diagnostics & management</div>
          <div style="margin-top:12px;"><button class="option-btn" onclick="openOverlay('case'); playTone('click')">Open Case Challenge</button></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Overlay container (for page transitions) -->
  <div id="overlay" class="overlay" aria-hidden="true" style="display:none;">
    <div id="overlayPanel" class="overlay-panel" role="dialog" aria-modal="true">
      <!-- Home button in overlay -->
      <button id="overlayHome" class="home-btn" title="Home" onclick="closeOverlay(); playTone('click')">üè†</button>

      <!-- Dynamic content will be injected here -->
      <div id="overlayContent" style="padding:20px;"></div>
    </div>
  </div>

  <script>
    /* ===========================
       GitHub Raw JSON URLs (your provided links)
       =========================== */
    const wordURL = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/DentalGameData/refs/heads/main/dental_words.json";
    const quizURL = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/DentalGameData/refs/heads/main/dental_quiz.json";
    const caseURL = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/DentalGameData/refs/heads/main/dental_cases.json";

    /* ===========================
       Web Audio: local tone generator
       =========================== */
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioCtx ? new AudioCtx() : null;
    let muted = false;

    function toggleMute(){
      muted = !muted;
      document.getElementById('muteBtn').setAttribute('aria-pressed', String(muted));
      const icon = document.getElementById('muteIcon');
      if(muted){
        icon && (icon.innerHTML = '<path d="M6 9v6h4l5 4V5L10 9H6z" fill="#7a8a94"/><path d="M19 5L15 9m0 6l4 4" stroke="#7a8a94" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>');
      } else {
        icon && (icon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z" fill="#06202b"/><path d="M19 8l-1.41 1.41L20.17 12l-2.58 2.59L19 16l3-3-3-5z" fill="#7a8a94"/>');
      }
      if(!audioCtx) return;
      if(!muted && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }

    function playTone(name){
      if(muted || !audioCtx) return;
      const now = audioCtx.currentTime;
      if(name === 'click'){
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = 'sine'; o.frequency.setValueAtTime(1200, now);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.06, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(now); o.stop(now + 0.14);
      } else if(name === 'correct'){
        const freqs = [880, 1320, 1760];
        freqs.forEach((f,i)=>{
          const o = audioCtx.createOscillator(), g = audioCtx.createGain();
          o.type = 'sine'; o.frequency.setValueAtTime(f, now + i*0.01);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.28);
          o.connect(g); g.connect(audioCtx.destination);
          o.start(now + i*0.01); o.stop(now + 0.32);
        });
      } else if(name === 'wrong'){
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(220, now);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(now); o.stop(now + 0.18);
      } else if(name === 'win'){
        const seq = [440,660,880,1320];
        seq.forEach((f,i)=>{
          const o = audioCtx.createOscillator(), g = audioCtx.createGain();
          o.type = 'sine'; o.frequency.setValueAtTime(f, now + i*0.08);
          g.gain.setValueAtTime(0.0001, now + i*0.08);
          g.gain.exponentialRampToValueAtTime(0.09, now + i*0.08 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.08 + 0.28);
          o.connect(g); g.connect(audioCtx.destination);
          o.start(now + i*0.08); o.stop(now + i*0.08 + 0.34);
        });
      }
    }

    /* ===========================
       UI helpers (ripple)
       =========================== */
    function ripple(el, evt){
      const r = document.createElement('span');
      r.className = 'ripple';
      const rect = el.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      r.style.width = r.style.height = size + 'px';
      // If event not available, center ripple
      const cx = (evt && evt.clientX) ? (evt.clientX - rect.left - size/2) : (rect.width/2 - size/2);
      const cy = (evt && evt.clientY) ? (evt.clientY - rect.top - size/2) : (rect.height/2 - size/2);
      r.style.left = cx + 'px';
      r.style.top = cy + 'px';
      el.appendChild(r);
      setTimeout(()=> r.remove(), 600);
    }

    /* ===========================
       Overlay (page transition) logic
       =========================== */
    const overlay = document.getElementById('overlay');
    const overlayPanel = document.getElementById('overlayPanel');
    const overlayContent = document.getElementById('overlayContent');

    function openOverlay(mode){
      // build content into overlayContent based on mode: 'wordscape'|'quiz'|'case'
      overlayContent.innerHTML = ''; // clear
      overlay.style.display = 'flex';
      // make overlay visible after a tick
      setTimeout(()=> overlay.classList.add('show'), 10);

      // depending on mode, render specific full-page UI
      if(mode === 'wordscape'){
        renderOverlayWordscape();
      } else if(mode === 'quiz'){
        renderOverlayQuiz();
      } else if(mode === 'case'){
        renderOverlayCase();
      }
      overlay.setAttribute('aria-hidden','false');
      // prevent body scroll while overlay visible
      document.body.style.overflow = 'hidden';
      updateHighScoreDisplays();
    }

    function closeOverlay(){
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      // animate hide then remove display
      setTimeout(()=>{
        overlay.style.display = 'none';
        overlayContent.innerHTML = '';
        // reset games
        resetWordscape();
        resetQuiz();
        resetCase();
        document.body.style.overflow = 'auto';
      }, 380);
    }

    // close on ESC
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlay.classList.contains('show')) closeOverlay(); });

    /* ===========================
         High-score keys
       =========================== */
    const KEY_WORD_HS = 'wordscapeHighScore_v1';
    const KEY_QUIZ_HS = 'quizHighScore_v1';
    const KEY_CASE_HS = 'caseHighScore_v1';
    function getHighScore(key){ return Number(localStorage.getItem(key) || 0); }
    function setHighScore(key, val){ localStorage.setItem(key, String(val)); }
    function updateHighScoreDisplays(){
      document.getElementById('word-high').textContent = 'üèÜ High Score: ' + getHighScore(KEY_WORD_HS);
      document.getElementById('quiz-high').textContent = 'üèÜ High Score: ' + getHighScore(KEY_QUIZ_HS);
      document.getElementById('case-high').textContent = 'üèÜ High Score: ' + getHighScore(KEY_CASE_HS);
    }

    /* ===========================
       WORDSCAPE (overlay render)
       =========================== */
    let words = [];
    let wsCurrent = '', wsShuffled = [], wsSelected = '', wsScore = 0;
    const defaultWords = ["ENAMEL","CROWN","MOLAR","PLAQUE","DENTIN","PULP","CARIES","GINGIVA"];

    function resetWordscape(){
      wsCurrent=''; wsShuffled=[]; wsSelected=''; wsScore=0;
    }

    async function renderOverlayWordscape(){
      overlayContent.innerHTML = `
        <div class="card" style="margin:0; position:relative;">
          <div class="game-header">
            <div><div class="game-title">üß© Dental Wordscape</div><div class="game-sub">Form dental terms by tapping letters</div></div>
            <div class="game-sub" id="overlay_word_high">üèÜ High Score: ${getHighScore(KEY_WORD_HS)}</div>
          </div>

          <div class="word-area" style="margin-top:14px;">
            <div id="overlay_word_display" style="font-size:26px; letter-spacing:8px; font-weight:700; color:var(--text); background:linear-gradient(90deg, rgba(30,174,219,0.06), rgba(58,160,255,0.04)); padding:12px 18px; border-radius:12px; min-width:220px; text-align:center;">‚Äî ‚Äî ‚Äî</div>
            <div id="overlay_letters_container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:12px;"></div>
            <div class="info-row" style="margin-top:12px;">
              <div class="feedback" id="overlay_word_msg"></div>
              <div class="score-pill" id="overlay_word_score">0</div>
            </div>
          </div>
        </div>
      `;

      // fetch words if needed
      if(words.length === 0){
        try{
          const r = await fetch(wordURL);
          const data = await r.json();
          if(Array.isArray(data) && data.length) words = data.map(s => String(s).toUpperCase());
        } catch(e){
          console.warn('Failed to fetch words, using fallback', e);
          words = defaultWords.slice();
        }
      }
      wsScore = 0;
      document.getElementById('overlay_word_score').textContent = wsScore;
      nextOverlayWord();
    }

    function nextOverlayWord(){
      if(!words.length) return;
      wsCurrent = String(words[Math.floor(Math.random()*words.length)] || '').toUpperCase().trim();
      wsCurrent = wsCurrent.replace(/[^A-Z]/g,'');
      if(wsCurrent.length === 0){ nextOverlayWord(); return; }
      wsShuffled = shuffle(wsCurrent.split(''));
      wsSelected = '';
      renderOverlayLetters();
      document.getElementById('overlay_word_display').textContent = Array.from({length: wsCurrent.length}).map(()=> '‚Ä¢').join(' ');
      document.getElementById('overlay_word_msg').textContent = '';
    }

    function renderOverlayLetters(){
      const container = document.getElementById('overlay_letters_container');
      container.innerHTML = '';
      wsShuffled.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.textContent = ch || '';
        btn.disabled = ch === '';
        btn.style.width = '60px';
        btn.style.height = '60px';
        btn.style.borderRadius = '12px';
        btn.style.fontWeight = '800';
        btn.onclick = (e) => {
          ripple(btn, e);
          if(btn.disabled) return;
          playTone('click');
          wsSelected += ch;
          wsShuffled[idx] = '';
          renderOverlayLetters();
          document.getElementById('overlay_word_display').textContent = wsSelected.split('').join(' ');
          if(wsSelected.length === wsCurrent.length) setTimeout(checkOverlayWord, 160);
        };
        container.appendChild(btn);
      });
    }

    function checkOverlayWord(){
      const msgEl = document.getElementById('overlay_word_msg');
      if(wsSelected === wsCurrent){
        msgEl.textContent = 'Correct ‚Äî ' + wsCurrent; msgEl.style.color = 'var(--success)';
        playTone('correct');
        wsScore += 10;
        document.getElementById('overlay_word_score').textContent = wsScore;
        // update HS
        const prev = getHighScore(KEY_WORD_HS);
        if(wsScore > prev){ setHighScore(KEY_WORD_HS, wsScore); document.getElementById('overlay_word_high') && (document.getElementById('overlay_word_high').textContent = 'üèÜ High Score: ' + wsScore); updateHighScoreDisplays(); }
        setTimeout(nextOverlayWord, 700);
      } else {
        msgEl.textContent = 'Incorrect ‚Äî try another word'; msgEl.style.color = 'var(--danger)';
        playTone('wrong');
        setTimeout(nextOverlayWord, 900);
      }
    }

    /* ===========================
       QUIZ overlay (15s timer)
       =========================== */
    let quizItems = [];
    let qIndex = 0, qScore = 0, quizTimer = null, timerSeconds = 15, timerRemaining = 15;
    const defaultQuiz = [{question:"Which tissue covers the crown of a tooth?", options:["Cementum","Dentin","Enamel","Pulp"], answer:"Enamel"}];

    function resetQuiz(){
      if(quizTimer) { clearInterval(quizTimer); quizTimer = null; }
      quizItems = [];
      qIndex = 0; qScore = 0;
    }

    async function renderOverlayQuiz(){
      overlayContent.innerHTML = `
      <div class="card" style="margin:0; position:relative;">
        <div class="game-header">
          <div><div class="game-title">üìò Dental Quiz</div><div class="game-sub">15s per question</div></div>
          <div class="game-sub" id="overlay_quiz_high">üèÜ High Score: ${getHighScore(KEY_QUIZ_HS)}</div>
        </div>

        <div style="margin-top:12px;">
          <div id="overlay_quiz_question" style="font-weight:700; font-size:18px; color:var(--text);">Loading...</div>
          <div class="timer-wrap"><div id="overlay_timer_bar" class="timer-bar" style="width:100%"></div></div>
          <div class="options" id="overlay_quiz_options" style="margin-top:12px;"></div>
          <div class="feedback" id="overlay_quiz_msg"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <div class="small">Quiz ‚Ä¢ Questions loaded from GitHub JSON</div>
            <div class="score-pill" id="overlay_quiz_score">0</div>
          </div>
        </div>
      </div>
      `;

      // fetch items
      try{
        const r = await fetch(quizURL);
        const data = await r.json();
        if(Array.isArray(data) && data.length) quizItems = data;
      } catch(e){
        console.warn('Failed to fetch quiz ‚Äî fallback', e);
        quizItems = defaultQuiz.slice();
      }
      qIndex = 0; qScore = 0;
      document.getElementById('overlay_quiz_score').textContent = qScore;
      renderOverlayQuizQuestion();
    }

    function startOverlayTimer(){
      stopOverlayTimer();
      timerRemaining = timerSeconds;
      const bar = document.getElementById('overlay_timer_bar');
      bar.style.width = '100%';
      const stepMs = 100;
      quizTimer = setInterval(()=> {
        timerRemaining -= stepMs/1000;
        const pct = Math.max(0, timerRemaining / timerSeconds);
        bar.style.width = (pct*100) + '%';
        if(timerRemaining <= 0){
          stopOverlayTimer();
          handleOverlayTimeout();
        }
      }, stepMs);
    }
    function stopOverlayTimer(){ if(quizTimer){ clearInterval(quizTimer); quizTimer = null; } }

    function renderOverlayQuizQuestion(){
      if(!quizItems.length) return;
      if(qIndex >= quizItems.length){
        document.getElementById('overlay_quiz_question').textContent = 'Quiz complete üéâ';
        document.getElementById('overlay_quiz_options').innerHTML = `<div style="padding:8px;color:var(--muted)">Final score: ${qScore}</div>`;
        playTone('win');
        // update HS
        const prev = getHighScore(KEY_QUIZ_HS);
        if(qScore > prev){ setHighScore(KEY_QUIZ_HS, qScore); updateHighScoreDisplays(); }
        stopOverlayTimer();
        return;
      }
      const cur = quizItems[qIndex];
      document.getElementById('overlay_quiz_question').textContent = cur.question;
      const optsEl = document.getElementById('overlay_quiz_options');
      optsEl.innerHTML = '';
      document.getElementById('overlay_quiz_msg').textContent = '';
      document.getElementById('overlay_quiz_score').textContent = qScore;
      document.getElementById('overlay_quiz_high') && (document.getElementById('overlay_quiz_high').textContent = 'üèÜ High Score: ' + getHighScore(KEY_QUIZ_HS));

      const shuffledOptions = shuffle(cur.options.map(o=>String(o)));
      shuffledOptions.forEach(opt => {
        const b = document.createElement('button');
        b.className = 'option-btn';
        b.textContent = opt;
        b.onclick = (e) => {
          // disable all
          document.querySelectorAll('#overlay_quiz_options .option-btn').forEach(x => x.disabled = true);
          stopOverlayTimer();
          if(opt === cur.answer){
            document.getElementById('overlay_quiz_msg').textContent = 'Correct!'; document.getElementById('overlay_quiz_msg').style.color = 'var(--success)';
            playTone('correct');
            qScore += 10; document.getElementById('overlay_quiz_score').textContent = qScore;
          } else {
            document.getElementById('overlay_quiz_msg').textContent = `Incorrect ‚Äî answer: ${cur.answer}`; document.getElementById('overlay_quiz_msg').style.color = 'var(--danger)';
            playTone('wrong');
          }
          // persist HS check when quiz ends (or update now)
          setTimeout(()=>{ qIndex++; renderOverlayQuizQuestion(); startOverlayTimer(); }, 900);
        };
        b.addEventListener('click', (ev)=> ripple(b, ev));
        optsEl.appendChild(b);
      });

      // ensure options visible (fix for missing choices)
      optsEl.scrollTop = 0;
      // start timer
      startOverlayTimer();
    }

    function handleOverlayTimeout(){
      const cur = quizItems[qIndex];
      // disable all option buttons
      document.querySelectorAll('#overlay_quiz_options .option-btn').forEach(x => x.disabled = true);
      document.getElementById('overlay_quiz_msg').textContent = `Time's up ‚Äî answer: ${cur.answer}`;
      document.getElementById('overlay_quiz_msg').style.color = 'var(--danger)';
      playTone('wrong');
      setTimeout(()=>{ qIndex++; renderOverlayQuizQuestion(); }, 900);
    }

    /* ===========================
       CASE overlay
       =========================== */
    let cases = [];
    let caseIndex = 0, caseScore = 0;
    const defaultCases = [{case:"25-year-old with sharp pain on biting in a lower molar with deep caries. Most likely?", options:["Gingivitis","Pulpitis","Periodontitis","Pericoronitis"], answer:"Pulpitis"}];

    function resetCase(){ cases=[]; caseIndex=0; caseScore=0; }

    async function renderOverlayCase(){
      overlayContent.innerHTML = `
      <div class="card" style="margin:0; position:relative;">
        <div class="game-header">
          <div><div class="game-title">üí¨ Case Challenge</div><div class="game-sub">Choose the best diagnosis / treatment</div></div>
          <div class="game-sub" id="overlay_case_high">üèÜ High Score: ${getHighScore(KEY_CASE_HS)}</div>
        </div>

        <div style="margin-top:12px;">
          <div id="overlay_case_stem" style="font-weight:700; font-size:16px; color:var(--text);">Loading cases...</div>
          <div class="options" id="overlay_case_options"></div>
          <div class="feedback" id="overlay_case_msg"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <div class="small">Cases ‚Ä¢ Editable on GitHub JSON</div>
            <div class="score-pill" id="overlay_case_score">0</div>
          </div>
        </div>
      </div>
      `;

      try{
        const r = await fetch(caseURL);
        const data = await r.json();
        if(Array.isArray(data) && data.length) cases = data;
      } catch(e){
        console.warn('Failed to fetch cases ‚Äî fallback', e);
        cases = defaultCases.slice();
      }
      caseIndex = 0; caseScore = 0; document.getElementById('overlay_case_score').textContent = caseScore;
      renderOverlayCaseItem();
    }

    function renderOverlayCaseItem(){
      if(!cases.length) return;
      if(caseIndex >= cases.length){
        document.getElementById('overlay_case_stem').textContent = 'All cases completed üéâ';
        document.getElementById('overlay_case_options').innerHTML = `<div style="padding:8px;color:var(--muted)">Final score: ${caseScore}</div>`;
        playTone('win');
        const prev = getHighScore(KEY_CASE_HS);
        if(caseScore > prev){ setHighScore(KEY_CASE_HS, caseScore); updateHighScoreDisplays(); }
        return;
      }
      const cur = cases[caseIndex];
      document.getElementById('overlay_case_stem').textContent = cur.case;
      const optsEl = document.getElementById('overlay_case_options');
      optsEl.innerHTML = '';
      document.getElementById('overlay_case_msg').textContent = '';
      const shuffledOpts = shuffle(cur.options.map(o=>String(o)));
      shuffledOpts.forEach(opt => {
        const b = document.createElement('button');
        b.className = 'option-btn';
        b.textContent = opt;
        b.onclick = (e) => {
          document.querySelectorAll('#overlay_case_options .option-btn').forEach(x => x.disabled = true);
          ripple(b, e);
          if(opt === cur.answer){
            document.getElementById('overlay_case_msg').textContent = 'Correct!'; document.getElementById('overlay_case_msg').style.color = 'var(--success)';
            playTone('correct');
            caseScore += 10;
            document.getElementById('overlay_case_score').textContent = caseScore;
          } else {
            document.getElementById('overlay_case_msg').textContent = `Incorrect ‚Äî answer: ${cur.answer}`; document.getElementById('overlay_case_msg').style.color = 'var(--danger)';
            playTone('wrong');
          }
          setTimeout(()=>{ caseIndex++; renderOverlayCaseItem(); }, 900);
        };
        optsEl.appendChild(b);
      });
      optsEl.scrollTop = 0;
    }

    /* ===========================
       Helpers
       =========================== */
    function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

    // init
    updateHighScoreDisplays();

    // resume audio ctx on first pointerdown for autoplay-blocking browsers
    window.addEventListener('pointerdown', () => {
      if(audioCtx && audioCtx.state === 'suspended' && !muted) audioCtx.resume().catch(()=>{});
    }, { once:true });
  </script>
</body>
</html>
