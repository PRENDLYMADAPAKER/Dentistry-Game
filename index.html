<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dental Learning Game</title>
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #f5f5f5;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    background: #007bff;
    color: #fff;
    text-align: center;
    padding: 15px 0;
    font-size: 20px;
    font-weight: bold;
  }
  #menu, #contentArea {
    width: 90%;
    max-width: 600px;
    margin-top: 25px;
    text-align: center;
  }
  button {
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    margin: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover { background: #0056b3; }
  .option-btn {
    display: block;
    width: 100%;
    margin: 8px 0;
  }
  .answered { background: #28a745 !important; }
  #muteBtn { position: fixed; top: 10px; right: 10px; }
  #timer { font-weight: bold; color: #ff4444; }
</style>
</head>
<body>
<header>🦷 Dental Learning Game</header>

<!-- 📦 Menu -->
<div id="menu">
  <button onclick="startWordscape()">🧩 Dental Wordscape</button>
  <button onclick="startQuiz()">🧠 Dental Quiz</button>
  <button onclick="startCase()">🩺 Case Challenge</button>
</div>

<!-- 📋 Game Content -->
<div id="contentArea" style="display:none;"></div>

<button id="muteBtn" onclick="toggleMute()">🔊</button>

<!-- 🧠 Local Data Files -->
<script src="dental_words.js"></script>
<script src="dental_quiz.js"></script>
<script src="dental_cases.js"></script>

<!-- 🎮 Game Logic -->
<script>
let muted = false;
let bgAudio, sfx = {};
let wordList = [], quizData = [], caseData = [];
let currentWord = "", selectedArr = [];
let wsScore = 0, quizIndex = 0, caseIndex = 0;
let quizAnswered = new Set(), caseAnswered = new Set();
let countdownTimer = null;
const KEY_WS_STATE = 'dh_wordscape_state';
const KEY_QUIZ_STATE = 'dh_quiz_state';
const KEY_CASE_STATE = 'dh_case_state';

/* 🔊 INIT SOUND */
function initAudio(){
  bgAudio = new Audio('bg_music.mp3'); bgAudio.loop = true;
  sfx.click = new Audio('click.mp3');
  sfx.correct = new Audio('correct.mp3');
  sfx.wrong = new Audio('wrong.mp3');
  sfx.timeout = new Audio('timeout.mp3');
  try { bgAudio.play(); } catch {}
}

/* 🎚️ Mute Toggle */
function toggleMute(){
  muted = !muted;
  bgAudio.muted = muted;
  for(let k in sfx) sfx[k].muted = muted;
  localStorage.setItem('muted', muted);
  document.getElementById('muteBtn').textContent = muted ? '🔇' : '🔊';
}
function playSFX(name){ if(!muted && sfx[name]) sfx[name].play(); }

/* 💾 JSON Cache Helpers */
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{return null;} }

/* 🧩 Load Data (from local JS vars) */
async function loadWordList(){
  if(window.dentalWords) wordList = window.dentalWords.map(w=>w.toUpperCase());
  else wordList = ["ENAMEL","CROWN","MOLAR"];
}
async function loadQuizList(){
  if(window.dentalQuiz) quizData = window.dentalQuiz;
  else quizData = [{question:"Fallback question",options:["A","B"],answer:"A"}];
}
async function loadCaseList(){
  if(window.dentalCases) caseData = window.dentalCases;
  else caseData = [{case:"Fallback case",options:["A","B"],answer:"A"}];
}

/* ⏱ Countdown */
function startCountdown(seconds, onTick, onExpire){
  clearInterval(countdownTimer);
  const t = document.getElementById('timer');
  let left = seconds;
  t.textContent = left;
  countdownTimer = setInterval(()=>{
    left--; t.textContent = left;
    if(onTick) onTick(left);
    if(left<=0){ clearInterval(countdownTimer); onExpire&&onExpire(); }
  },1000);
}
function stopAllTimers(){ clearInterval(countdownTimer); }

/* 🏠 Back to Menu */
function showMenu(){
  document.getElementById('contentArea').style.display='none';
  document.getElementById('menu').style.display='block';
}

/* 🧩 WORDSCAPE GAME */
async function startWordscape(){
  await loadWordList(); initAudio();
  document.getElementById('menu').style.display='none';
  const content=document.getElementById('contentArea');
  content.style.display='block';
  content.innerHTML=`
    <h2>🧩 Dental Wordscape</h2>
    <p id="timer"></p>
    <div id="letters"></div>
    <div id="answer"></div>
    <p>Score: <span id="score">${wsScore}</span></p>
    <button onclick="showMenu()">🏠 Menu</button>
  `;

  let saved=loadJSON(KEY_WS_STATE);
  if(saved){ currentWord=saved.currentWord; selectedArr=saved.selectedArr; wsScore=saved.wsScore; }
  else { currentWord=randomWord(); selectedArr=[]; wsScore=0; }
  renderWordscapeUI(); 
  startCountdown(15,null,()=>{playSFX('timeout');nextWord();});
}

function randomWord(){ return wordList[Math.floor(Math.random()*wordList.length)]; }

function renderWordscapeUI(){
  const lettersEl=document.getElementById('letters');
  const answerEl=document.getElementById('answer');
  answerEl.textContent=selectedArr.join('');
  lettersEl.innerHTML='';
  const shuffled=[...currentWord].sort(()=>Math.random()-0.5);
  shuffled.forEach(ch=>{
    const btn=document.createElement('button');
    btn.textContent=ch;
    btn.onclick=()=>selectLetter(ch);
    lettersEl.appendChild(btn);
  });
}

function selectLetter(ch){
  playSFX('click');
  selectedArr.push(ch);
  document.getElementById('answer').textContent=selectedArr.join('');
  if(selectedArr.join('')===currentWord){ 
    playSFX('correct'); 
    wsScore++; 
    document.getElementById('score').textContent=wsScore; 
    saveJSON(KEY_WS_STATE,{currentWord,selectedArr,wsScore});
    setTimeout(nextWord,800);
  }
}

function nextWord(){
  stopAllTimers();
  selectedArr=[]; currentWord=randomWord();
  renderWordscapeUI();
  startCountdown(15,null,()=>{playSFX('timeout');nextWord();});
}

/* 🧠 QUIZ GAME */
async function startQuiz(){
  await loadQuizList(); initAudio();
  document.getElementById('menu').style.display='none';
  const c=document.getElementById('contentArea');
  c.style.display='block';
  c.innerHTML=`<h2>🧠 Dental Quiz</h2><p id="timer"></p><div id="quizQ"></div><div id="quizOpts"></div>
  <button id="prevBtn">⬅️ Previous</button><button onclick="showMenu()">🏠 Menu</button>`;
  let saved=loadJSON(KEY_QUIZ_STATE);
  if(saved){ quizIndex=saved.quizIndex; quizAnswered=new Set(saved.quizAnswered||[]); }
  renderQuizQuestion();
}

function renderQuizQuestion(){
  const q=quizData[quizIndex];
  document.getElementById('quizQ').innerHTML=`<h3>${quizAnswered.has(quizIndex)?'✅ ':''}${q.question}</h3>`;
  const opts=document.getElementById('quizOpts'); opts.innerHTML='';
  q.options.forEach(opt=>{
    const b=document.createElement('button');
    b.className='option-btn'; b.textContent=opt;
    if(quizAnswered.has(quizIndex)) b.disabled=true;
    b.onclick=()=>{
      playSFX('click');
      if(opt===q.answer){ playSFX('correct'); b.classList.add('answered'); }
      else playSFX('wrong');
      quizAnswered.add(quizIndex);
      saveJSON(KEY_QUIZ_STATE,{quizIndex,quizAnswered:[...quizAnswered]});
      setTimeout(()=>{quizIndex=(quizIndex+1)%quizData.length;renderQuizQuestion();},800);
    };
    opts.appendChild(b);
  });
  document.getElementById('prevBtn').onclick=()=>{quizIndex=(quizIndex-1+quizData.length)%quizData.length;renderQuizQuestion();};
  startCountdown(15,null,()=>{playSFX('timeout');quizIndex=(quizIndex+1)%quizData.length;renderQuizQuestion();});
}

/* 🩺 CASE CHALLENGE */
async function startCase(){
  await loadCaseList(); initAudio();
  document.getElementById('menu').style.display='none';
  const c=document.getElementById('contentArea');
  c.style.display='block';
  c.innerHTML=`<h2>🩺 Case Challenge</h2><p id="timer"></p><div id="caseQ"></div><div id="caseOpts"></div>
  <button id="prevCase">⬅️ Previous</button><button onclick="showMenu()">🏠 Menu</button>`;
  let saved=loadJSON(KEY_CASE_STATE);
  if(saved){ caseIndex=saved.caseIndex; caseAnswered=new Set(saved.caseAnswered||[]); }
  renderCaseQuestion();
}

function renderCaseQuestion(){
  const q=caseData[caseIndex];
  document.getElementById('caseQ').innerHTML=`<h3>${caseAnswered.has(caseIndex)?'✅ ':''}${q.case}</h3>`;
  const opts=document.getElementById('caseOpts'); opts.innerHTML='';
  q.options.forEach(opt=>{
    const b=document.createElement('button');
    b.className='option-btn'; b.textContent=opt;
    if(caseAnswered.has(caseIndex)) b.disabled=true;
    b.onclick=()=>{
      playSFX('click');
      if(opt===q.answer){ playSFX('correct'); b.classList.add('answered'); }
      else playSFX('wrong');
      caseAnswered.add(caseIndex);
      saveJSON(KEY_CASE_STATE,{caseIndex,caseAnswered:[...caseAnswered]});
      setTimeout(()=>{caseIndex=(caseIndex+1)%caseData.length;renderCaseQuestion();},800);
    };
    opts.appendChild(b);
  });
  document.getElementById('prevCase').onclick=()=>{caseIndex=(caseIndex-1+caseData.length)%caseData.length;renderCaseQuestion();};
  startCountdown(15,null,()=>{playSFX('timeout');caseIndex=(caseIndex+1)%caseData.length;renderCaseQuestion();});
}

/* 🏁 INIT ON LOAD */
window.onload=()=>{
  muted = localStorage.getItem('muted')==='true';
  if(!bgAudio) initAudio();
  document.getElementById('muteBtn').textContent = muted ? '🔇' : '🔊';
};
</script>
</body>
</html>
