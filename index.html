<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dental Hub Games</title>
<style>
  :root{
    --accent:#00eaff; --accent2:#00ffb7; --glass-bg: rgba(0,40,80,0.36);
    --muted:#b6eaff; --white:#fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: radial-gradient(circle at top left, #001427 0%, #00111f 35%, #000814 100%);
    color:var(--white); min-height:100vh; overflow-x:hidden;
  }
  .bubbles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
  .bubble{position:absolute;bottom:-120px;border-radius:50%;background:rgba(255,255,255,0.12);filter:blur(0.6px);
    animation:rise linear infinite;box-shadow:0 6px 18px rgba(0,200,255,0.035);}
  @keyframes rise{0%{transform:translateY(0) scale(1);opacity:.9;}100%{transform:translateY(-140vh) scale(1.6);opacity:0;}}
  header{text-align:center;padding-top:30px;z-index:2;position:relative;}
  header h1{margin:0;font-size:28px;letter-spacing:1px;
    background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  header p{margin:6px 0 0;font-style:italic;color:var(--muted);}
  main{z-index:2;position:relative;padding:28px 18px 60px;display:flex;flex-direction:column;align-items:center;gap:20px;}
  .home{display:flex;flex-direction:column;gap:16px;width:100%;max-width:920px;align-items:center;}
  .tile{width:92%;max-width:720px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border-radius:20px;padding:18px;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:12px;
    border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:transform .22s,box-shadow .22s;backdrop-filter:blur(10px);}
  .tile:hover{transform:translateY(-6px);box-shadow:0 30px 60px rgba(0,0,0,0.35);}
  .tile .left{display:flex;align-items:center;gap:14px;}
  .tile .icon{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-weight:800;
    background:linear-gradient(135deg,var(--accent),var(--accent2));color:#002;box-shadow:0 8px 30px rgba(0,224,255,0.08);}
  .tile h3{margin:0;font-size:18px;}
  .tile p{margin:4px 0 0;color:var(--muted);font-size:13px;}
  .game-area{display:none;width:100%;max-width:920px;justify-content:center;padding:24px;}
  .game-panel{width:92%;max-width:640px;margin:0 auto;background:var(--glass-bg);border-radius:20px;padding:20px;
    color:var(--white);backdrop-filter:blur(14px) saturate(150%);-webkit-backdrop-filter:blur(14px) saturate(150%);
    border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 80px rgba(0,0,0,0.45);transform-origin:center;opacity:0;
    transform:scale(.98) translateY(10px);transition:transform .36s cubic-bezier(.2,.9,.3,1),opacity .28s;}
  .game-panel.show{opacity:1;transform:scale(1) translateY(0);}
  .game-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;}
  .home-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:var(--white);
    padding:8px 12px;border-radius:12px;cursor:pointer;}
  .home-btn:hover{background:rgba(255,255,255,0.09);transform:translateY(-2px);}
  .game-stats{display:flex;align-items:center;gap:12px;font-weight:700;color:var(--muted);}
  .game-stats span strong{color:var(--white);margin-left:6px;}
  h2#question{text-align:center;margin:16px 0 18px;font-size:20px;}
  .options{display:flex;flex-direction:column;gap:10px;}
  .option-btn{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:12px;color:var(--white);font-weight:700;
    cursor:pointer;transition:transform .16s,background .16s;}
  .option-btn:hover{transform:translateY(-4px);background:rgba(255,255,255,0.03);}
  .word-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0;}
  .letter-chip{background:rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;font-weight:800;cursor:pointer;}
  .controls{position:fixed;right:18px;bottom:18px;z-index:10;display:flex;gap:8px;}
  .circle-btn{width:46px;height:46px;border-radius:50%;border:none;background:rgba(255,255,255,0.05);
    color:var(--white);cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.4);}
  @media(max-width:700px){
    header h1{font-size:20px;}
    .tile{width:94%;}
    .game-panel{width:94%;padding:16px;border-radius:16px;}
  }
</style>
</head>
<body>
<div class="bubbles" id="bubbles"></div>
<header>
  <h1>DENTAL HUB GAMES</h1>
  <p><i>Test your knowledge</i></p>
</header>

<main>
  <section class="home" id="home">
    <div class="tile" id="openWordscape"><div class="left">
      <div class="icon">üß©</div><div><h3>Dental Wordscape</h3><p>Form dental terms from letters</p></div></div>
      <div class="meta"><strong id="hsWord">0</strong> pts</div>
    </div>
    <div class="tile" id="openQuiz"><div class="left">
      <div class="icon">üìò</div><div><h3>Dental Quiz Game</h3><p>Timed multiple-choice (15s)</p></div></div>
      <div class="meta"><strong id="hsQuiz">0</strong> pts</div>
    </div>
    <div class="tile" id="openCase"><div class="left">
      <div class="icon">üí¨</div><div><h3>Case Challenge</h3><p>Clinical scenario practice</p></div></div>
      <div class="meta"><strong id="hsCase">0</strong> pts</div>
    </div>
  </section>

  <section class="game-area" id="gameArea" aria-hidden="true">
    <div class="game-panel" id="gamePanel">
      <div class="game-header">
        <button class="home-btn" id="btnHome">üè†</button>
        <div class="game-stats">
          <span>Score <strong id="scoreDisplay">0</strong></span>
          <span>‚è± <strong id="timerDisplay">15</strong>s</span>
        </div>
      </div>
      <h2 id="question">Loading...</h2>
      <div id="contentArea"></div>
    </div>
  </section>
</main>

<div class="controls">
  <button id="muteBtn" class="circle-btn" title="Mute / Unmute">üîä</button>
  <button id="backspaceBtn" class="circle-btn" title="Undo last (Wordscape)">‚å´</button>
</div>

<audio id="bgAudio" loop crossorigin="anonymous">
  <source src="https://cdn.pixabay.com/download/audio/2023/03/08/audio_6e56e3a30a.mp3?filename=relaxing-background-music-141069.mp3" type="audio/mpeg">
</audio>

<script>
/* ------------------ Configuration ------------------ */
const wordURL = "https://cdn.jsdelivr.net/gh/PRENDLYMADAPAKER/DentalGameData/dental_words.json";
const quizURL = "https://cdn.jsdelivr.net/gh/PRENDLYMADAPAKER/DentalGameData/dental_quiz.json";
const caseURL = "https://cdn.jsdelivr.net/gh/PRENDLYMADAPAKER/DentalGameData/dental_cases.json";

/* ------------------ Elements ------------------ */
const bubblesEl = document.getElementById('bubbles');
const homeEl = document.getElementById('home');
const gameArea = document.getElementById('gameArea');
const gamePanel = document.getElementById('gamePanel');
const contentArea = document.getElementById('contentArea');
const questionEl = document.getElementById('question');
const scoreDisplay = document.getElementById('scoreDisplay');
const timerDisplay = document.getElementById('timerDisplay');
const btnHome = document.getElementById('btnHome');
const muteBtn = document.getElementById('muteBtn');
const backspaceBtn = document.getElementById('backspaceBtn');
const bgAudio = document.getElementById('bgAudio');

/* ------------------ Visual ------------------ */
function makeBubbles(c=22){for(let i=0;i<c;i++){const b=document.createElement('div');b.className='bubble';
  const s=12+Math.random()*42;b.style.width=b.style.height=s+'px';b.style.left=(Math.random()*100)+'vw';
  b.style.animationDuration=(8+Math.random()*9)+'s';b.style.opacity=(0.5+Math.random()*0.6);
  bubblesEl.appendChild(b);}}
makeBubbles();

/* ------------------ Audio ------------------ */
let muted = localStorage.getItem('muted')==='true';
const sfx={click:new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_0f0f3f2c2a.mp3?filename=soft-click-6002.mp3"),
correct:new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e7c1e3b36.mp3?filename=correct-2-46134.mp3"),
wrong:new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_262f2667c2.mp3?filename=error-126627.mp3"),
timeout:new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_d4a5e562c2.mp3?filename=timeout-107404.mp3")};
Object.values(sfx).forEach(a=>a.preload="auto");

bgAudio.volume=0.16;bgAudio.loop=true;bgAudio.muted=muted;
bgAudio.play().catch(()=>{});
muteBtn.textContent=muted?'üîá':'üîä';

muteBtn.addEventListener('click',()=>{muted=!muted;localStorage.setItem('muted',muted);
bgAudio.muted=muted;muteBtn.textContent=muted?'üîá':'üîä';});
function playSFX(t){if(muted)return;const a=sfx[t];if(a){a.currentTime=0;a.play().catch(()=>{});}}

/* ------------------ Highscore helpers ------------------ */
const KEY_HS_WORD='dh_hs_word_v1',KEY_HS_QUIZ='dh_hs_quiz_v1',KEY_HS_CASE='dh_hs_case_v1';
function getHS(k){return Number(localStorage.getItem(k)||0);}function setHS(k,v){localStorage.setItem(k,String(v));}
function refreshHSUI(){document.getElementById('hsWord').textContent=getHS(KEY_HS_WORD);
document.getElementById('hsQuiz').textContent=getHS(KEY_HS_QUIZ);
document.getElementById('hsCase').textContent=getHS(KEY_HS_CASE);}
refreshHSUI();

 /* ------------------ State keys ------------------ */
const KEY_WS_STATE = 'dh_ws_state_v1';
const KEY_QUIZ_STATE = 'dh_quiz_state_v1';
const KEY_CASE_STATE = 'dh_case_state_v1';

/* ------------------ Timers (shared) ------------------ */
let currentTimer = null;
function stopAllTimers(){
  if(currentTimer){ clearInterval(currentTimer); currentTimer = null; }
}
function startCountdown(seconds, onTick, onExpire){
  stopAllTimers();
  let t = Math.max(0, Math.floor(seconds));
  timerDisplay.textContent = t;
  onTick && onTick(t);
  currentTimer = setInterval(()=>{
    t--;
    timerDisplay.textContent = Math.max(0, t);
    onTick && onTick(t);
    if(t <= 0){
      clearInterval(currentTimer); currentTimer = null;
      onExpire && onExpire();
    }
  }, 1000);
}

/* ------------------ Utility ------------------ */
function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

/* ------------------ Persist / restore helpers ------------------ */
function saveJSON(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
}
function loadJSON(key){
  try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : null; }catch(e){ return null; }
}

/* ---------------------------
   WORDSCAPE (save/restore + flow)
   --------------------------- */
let wordList = [], currentWord = '', shuffledLetters = [], selectedArr = [], wsScore = 0;
let ws_timeLeft = 15;

async function startWordscape(){
  stopAllTimers();
  openGamePanel();
  backspaceBtn.style.display = 'inline-block';

  // load word list
  try{
    const r = await fetch(wordURL);
    const d = await r.json();
    if(Array.isArray(d) && d.length) wordList = d.map(s=>String(s).toUpperCase());
    else if(Array.isArray(d.words)) wordList = d.words.map(s=>String(s).toUpperCase());
    else throw new Error('bad format');
  }catch(e){
    // fallback minimal list
    wordList = ["ENAMEL","CROWN","MOLAR","PLAQUE","DENTIN","PULP","CARIES","GINGIVA"];
  }

  // try to restore saved state
  const s = loadJSON(KEY_WS_STATE);
  if(s && s.currentWord){
    // restore
    currentWord = s.currentWord;
    shuffledLetters = s.shuffledLetters || shuffle(currentWord.split(''));
    selectedArr = s.selectedArr || [];
    wsScore = Number(s.wsScore||getHS(KEY_HS_WORD));
    ws_timeLeft = typeof s.timeLeft === 'number' ? s.timeLeft : 15;
    // make sure lengths OK
    if(!Array.isArray(shuffledLetters) || shuffledLetters.length === 0){
      shuffledLetters = shuffle(currentWord.split(''));
    }
    scoreDisplay.textContent = wsScore;
    renderWordscapeUI();
    startCountdown(ws_timeLeft, (t)=> { ws_timeLeft = t; }, ()=> {
      playSFX('timeout');
      // mark as skipped and go next (preserve that this question was skipped in storage)
      prepareNextWord();
    });
  } else {
    // fresh start
    wsScore = getHS(KEY_HS_WORD);
    scoreDisplay.textContent = wsScore;
    prepareNextWord();
  }
}

function saveWordscapeState(){
  const st = {
    currentWord, shuffledLetters, selectedArr, wsScore,
    timeLeft: Number(timerDisplay.textContent) || 15
  };
  saveJSON(KEY_WS_STATE, st);
}

function clearWordscapeState(){
  localStorage.removeItem(KEY_WS_STATE);
}

function prepareNextWord(){
  stopAllTimers();
  selectedArr = [];
  currentWord = String(wordList[Math.floor(Math.random()*wordList.length)] || 'ENAMEL').toUpperCase().replace(/[^A-Z]/g,'');
  shuffledLetters = shuffle(currentWord.split(''));
  // reset time
  ws_timeLeft = 15;
  renderWordscapeUI();
  saveWordscapeState();
  startCountdown(ws_timeLeft, (t)=>{ ws_timeLeft = t; }, ()=> { playSFX('timeout'); setTimeout(prepareNextWord, 600); });
}

function renderWordscapeUI(){
  questionEl.textContent = 'Form the word';
  const chips = selectedArr.map((c, idx)=> `<div class="letter-chip" data-idx="${idx}">${c}</div>`).join('');
  const lettersButtons = shuffledLetters.map((ch, i)=> `<button class="option-btn letter-btn" data-i="${i}" ${ch===''?'disabled':''}>${ch || ''}</button>`).join('');
  contentArea.innerHTML = `
    <div class="word-row" id="wsChips">${chips}</div>
    <div style="text-align:center; font-weight:700; margin-bottom:8px">(${selectedArr.join('') || Array.from({length:currentWord.length}).map(()=> '‚Ä¢').join(' ')})</div>
    <div class="word-row" id="wsLetters">${lettersButtons}</div>
    <div style="margin-top:12px; text-align:center; color:var(--muted)" id="wsMsg"></div>
    <div style="margin-top:10px;text-align:center;color:var(--muted);font-size:13px">Tip: tap letters to build, tap chips to remove</div>
  `;

  // letter buttons
  contentArea.querySelectorAll('.letter-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.getAttribute('data-i'));
      if(btn.disabled) return;
      playSFX('click');
      selectedArr.push(shuffledLetters[i]);
      shuffledLetters[i] = '';
      renderWordscapeUI();
      saveWordscapeState();
      if(selectedArr.length === currentWord.length){
        const formed = selectedArr.join('');
        if(formed === currentWord){
          playSFX('correct');
          wsScore += 10;
          setHS(KEY_HS_WORD, wsScore);
          scoreDisplay.textContent = wsScore;
          document.getElementById('wsMsg').textContent = '‚úÖ Correct ‚Äî ' + formed;
          // clear saved current word (so next time user resumes they get next)
          clearWordscapeState();
          setTimeout(()=>prepareNextWord(), 700);
        } else {
          playSFX('wrong');
          document.getElementById('wsMsg').textContent = '‚ùå Incorrect ‚Äî try again';
          setTimeout(()=>prepareNextWord(), 900);
        }
      }
    });
  });

  // chip removal
  contentArea.querySelectorAll('.letter-chip').forEach(chip=>{
    chip.addEventListener('click', ()=>{
      const idx = Number(chip.getAttribute('data-idx'));
      const removed = selectedArr.splice(idx,1)[0];
      const emptyIndex = shuffledLetters.indexOf('');
      if(emptyIndex !== -1) shuffledLetters[emptyIndex] = removed;
      else shuffledLetters.push(removed);
      playSFX('click');
      renderWordscapeUI();
      saveWordscapeState();
    });
  });

  // backspace
  backspaceBtn.onclick = ()=> {
    if(selectedArr.length === 0) return;
    const removed = selectedArr.pop();
    const emptyIdx = shuffledLetters.indexOf('');
    if(emptyIdx !== -1) shuffledLetters[emptyIdx] = removed;
    else shuffledLetters.push(removed);
    playSFX('click');
    renderWordscapeUI();
    saveWordscapeState();
  };
}

/* ---------------------------
   QUIZ (save/restore + previous + answered)
   --------------------------- */
let quizData = [], quizIndex = 0, quizScore = 0;
let quiz_state = {
  index:0,
  score:0,
  answeredMap: {}, // index -> {status:'answered'|'skipped', selected:choice}
  timeLeft: 15
};

async function startQuiz(){
  stopAllTimers();
  openGamePanel();
  backspaceBtn.style.display = 'none';

  try{
    const res = await fetch(quizURL);
    const d = await res.json();
    if(Array.isArray(d) && d.length) quizData = d;
    else if(Array.isArray(d.questions)) quizData = d.questions;
  }catch{
    quizData = [{question:"Which tissue covers the crown of a tooth?", options:["Cementum","Dentin","Enamel","Pulp"], answer:"Enamel"}];
  }

  // try restore
  const s = loadJSON(KEY_QUIZ_STATE);
  if(s && Array.isArray(quizData) && quizData.length){
    quiz_state = Object.assign(quiz_state, s);
    quizIndex = quiz_state.index || 0;
    quizScore = Number(quiz_state.score || getHS(KEY_HS_QUIZ));
    scoreDisplay.textContent = quizScore;
    renderQuizQuestion();
  } else {
    quizIndex = 0;
    quizScore = getHS(KEY_HS_QUIZ);
    quiz_state = { index:0, score:quizScore, answeredMap:{}, timeLeft:15 };
    scoreDisplay.textContent = quizScore;
    renderQuizQuestion();
  }
}

function saveQuizState(){
  quiz_state.index = quizIndex;
  quiz_state.score = quizScore;
  quiz_state.timeLeft = Number(timerDisplay.textContent) || 15;
  saveJSON(KEY_QUIZ_STATE, quiz_state);
}
function clearQuizState(){
  localStorage.removeItem(KEY_QUIZ_STATE);
}

function renderQuizQuestion(){
  stopAllTimers();
  const q = quizData[quizIndex];
  if(!q){ questionEl.textContent = 'No questions'; contentArea.innerHTML=''; return; }
  const qText = q.question || q.stem || 'Untitled question';
  const choices = q.options || q.choices || [];
  const correct = q.answer || q.correct || '';
  const statusObj = quiz_state.answeredMap[String(quizIndex)] || null;
  const statusLabel = statusObj ? (statusObj.status==='answered' ? '‚úÖ Answered' : '‚è≠ Skipped') : '';

  questionEl.textContent = (statusLabel ? statusLabel + ' ¬∑ ' : '') + qText;

  contentArea.innerHTML = `<div class="options" id="quizOptions"></div>
    <div style="margin-top:10px;text-align:center">
      <button class="option-btn" id="prevBtn">‚¨ÖÔ∏è Previous</button>
      <button class="option-btn" id="nextBtn" style="margin-left:8px">Next ‚û°Ô∏è</button>
    </div>
    <div id="quizMsg" style="margin-top:8px;text-align:center;color:var(--muted)"></div>`;

  const optWrap = document.getElementById('quizOptions');
  shuffle(choices).forEach(choice=>{
    const b = document.createElement('button');
    b.className = 'option-btn';
    b.textContent = choice;
    // if already answered, disable buttons and show selected
    if(statusObj && statusObj.status === 'answered'){
      b.disabled = true;
      if(String(statusObj.selected).trim().toLowerCase() === String(choice).trim().toLowerCase()){
        b.style.boxShadow = '0 0 0 3px rgba(0,255,183,0.08)';
      }
    }
    b.addEventListener('click', ()=>{
      optWrap.querySelectorAll('button').forEach(x=> x.disabled = true);
      stopAllTimers();
      playSFX('click');
      const correctMatch = String(choice).trim().toLowerCase() === String(correct).trim().toLowerCase();
      if(correctMatch){
        playSFX('correct');
        quizScore += 10;
        setHS(KEY_HS_QUIZ, quizScore);
        quiz_state.answeredMap[String(quizIndex)] = { status:'answered', selected:choice };
      } else {
        playSFX('wrong');
        quiz_state.answeredMap[String(quizIndex)] = { status:'answered', selected:choice };
      }
      scoreDisplay.textContent = quizScore;
      saveQuizState();
      document.getElementById('quizMsg').textContent = correctMatch ? '‚úÖ Correct' : '‚ùå Incorrect';
      setTimeout(()=>{ quizIndex = (quizIndex + 1) % quizData.length; renderQuizQuestion(); }, 800);
    });
    optWrap.appendChild(b);
  });

  // prev/next handlers
  document.getElementById('prevBtn').addEventListener('click', ()=>{
    playSFX('click');
    quizIndex = (quizIndex - 1 + quizData.length) % quizData.length;
    renderQuizQuestion();
  });
  document.getElementById('nextBtn').addEventListener('click', ()=>{
    playSFX('click');
    quizIndex = (quizIndex + 1) % quizData.length;
    renderQuizQuestion();
  });

  // countdown: when times up mark as skipped and advance
  startCountdown(quiz_state.timeLeft || 15, (t)=>{ quiz_state.timeLeft = t; }, ()=> {
    playSFX('timeout');
    // mark skipped (but allow user to come back)
    quiz_state.answeredMap[String(quizIndex)] = { status:'skipped', selected:null };
    document.getElementById('quizMsg').textContent = '‚è± Time\'s up! Moving to next question...';
    saveQuizState();
    setTimeout(()=>{ quizIndex = (quizIndex + 1) % quizData.length; renderQuizQuestion(); }, 900);
  });
}

/* ---------------------------
   CASE CHALLENGE (similar to quiz)
   --------------------------- */
let caseData = [], caseIndex = 0, caseScore = 0;
let case_state = { index:0, score:0, answeredMap:{}, timeLeft:15 };

async function startCase(){
  stopAllTimers();
  openGamePanel();
  backspaceBtn.style.display = 'none';

  try{
    const r = await fetch(caseURL);
    const d = await r.json();
    if(Array.isArray(d) && d.length) caseData = d;
    else if(Array.isArray(d.cases)) caseData = d.cases;
  }catch{
    caseData = [{case:"25-year-old with sharp pain on biting lower molar with deep caries. Most likely?", options:["Gingivitis","Pulpitis","Periodontitis","Pericoronitis"], answer:"Pulpitis"}];
  }

  const s = loadJSON(KEY_CASE_STATE);
  if(s && Array.isArray(caseData) && caseData.length){
    case_state = Object.assign(case_state, s);
    caseIndex = case_state.index || 0;
    caseScore = Number(case_state.score || getHS(KEY_HS_CASE));
    scoreDisplay.textContent = caseScore;
    renderCaseQuestion();
  } else {
    caseIndex = 0;
    caseScore = getHS(KEY_HS_CASE);
    case_state = { index:0, score:caseScore, answeredMap:{}, timeLeft:15 };
    scoreDisplay.textContent = caseScore;
    renderCaseQuestion();
  }
}

function saveCaseState(){
  case_state.index = caseIndex;
  case_state.score = caseScore;
  case_state.timeLeft = Number(timerDisplay.textContent) || 15;
  saveJSON(KEY_CASE_STATE, case_state);
}
function clearCaseState(){ localStorage.removeItem(KEY_CASE_STATE); }

function renderCaseQuestion(){
  stopAllTimers();
  const c = caseData[caseIndex];
  if(!c){ questionEl.textContent='No cases'; contentArea.innerHTML=''; return; }
  const stem = c.case || c.title || 'Case';
  const choices = c.options || c.choices || [];
  const correct = c.answer || c.correct || '';
  const statusObj = case_state.answeredMap[String(caseIndex)] || null;
  const statusLabel = statusObj ? (statusObj.status==='answered' ? '‚úÖ Answered' : '‚è≠ Skipped') : '';

  questionEl.textContent = (statusLabel ? statusLabel + ' ¬∑ ' : '') + stem;

  contentArea.innerHTML = `<div class="options" id="caseOptions"></div>
    <div style="margin-top:10px;text-align:center">
      <button class="option-btn" id="prevCaseBtn">‚¨ÖÔ∏è Previous</button>
      <button class="option-btn" id="nextCaseBtn" style="margin-left:8px">Next ‚û°Ô∏è</button>
    </div>
    <div id="caseMsg" style="margin-top:8px;text-align:center;color:var(--muted)"></div>`;

  const w = document.getElementById('caseOptions');
  shuffle(choices).forEach(opt=>{
    const b = document.createElement('button');
    b.className = 'option-btn';
    b.textContent = opt;
    if(statusObj && statusObj.status === 'answered'){
      b.disabled = true;
      if(String(statusObj.selected).trim().toLowerCase() === String(opt).trim().toLowerCase()){
        b.style.boxShadow = '0 0 0 3px rgba(0,255,183,0.08)';
      }
    }
    b.addEventListener('click', ()=>{
      w.querySelectorAll('button').forEach(x=>x.disabled=true);
      stopAllTimers();
      playSFX('click');
      const correctMatch = String(opt).trim().toLowerCase() === String(correct).trim().toLowerCase();
      if(correctMatch){
        playSFX('correct');
        caseScore += 10;
        setHS(KEY_HS_CASE, caseScore);
        case_state.answeredMap[String(caseIndex)] = { status:'answered', selected:opt };
      } else {
        playSFX('wrong');
        case_state.answeredMap[String(caseIndex)] = { status:'answered', selected:opt };
      }
      scoreDisplay.textContent = caseScore;
      saveCaseState();
      document.getElementById('caseMsg').textContent = correctMatch ? '‚úÖ Correct' : '‚ùå Incorrect';
      setTimeout(()=>{ caseIndex = (caseIndex + 1) % caseData.length; renderCaseQuestion(); }, 800);
    });
    w.appendChild(b);
  });

  document.getElementById('prevCaseBtn').addEventListener('click', ()=>{
    playSFX('click');
    caseIndex = (caseIndex - 1 + caseData.length) % caseData.length;
    renderCaseQuestion();
  });
  document.getElementById('nextCaseBtn').addEventListener('click', ()=>{
    playSFX('click');
    caseIndex = (caseIndex + 1) % caseData.length;
    renderCaseQuestion();
  });

  startCountdown(case_state.timeLeft || 15, (t)=>{ case_state.timeLeft = t; }, ()=> {
    playSFX('timeout');
    case_state.answeredMap[String(caseIndex)] = { status:'skipped', selected:null };
    document.getElementById('caseMsg').textContent = '‚è± Time\'s up! Moving to next...';
    saveCaseState();
    setTimeout(()=>{ caseIndex = (caseIndex + 1) % caseData.length; renderCaseQuestion(); }, 900);
  });
}

/* ---------------------------
   Panel navigation save hook
   --------------------------- */
// when pressing home button, save current game state if any and close
btnHome.addEventListener('click', ()=> {
  // save specific states depending on which game is open (we can detect by content)
  // save wordscape if it's active
  if(contentArea.querySelector('#wsLetters')){
    saveWordscapeState();
  } else if(contentArea.querySelector('#quizOptions')){
    saveQuizState();
  } else if(contentArea.querySelector('#caseOptions')){
    saveCaseState();
  }
  closeGamePanel();
});

// also save state when user navigates away or closes tab
window.addEventListener('beforeunload', ()=>{
  if(contentArea.querySelector('#wsLetters')) saveWordscapeState();
  if(contentArea.querySelector('#quizOptions')) saveQuizState();
  if(contentArea.querySelector('#caseOptions')) saveCaseState();
});

/* ---------------------------
   Small housekeeping / autoplay resume
   --------------------------- */
refreshHSUI();
gameArea.style.display='none';
backspaceBtn.style.display='none';

// pointerdown to allow audio on some platforms
window.addEventListener('pointerdown', function resumeAudio(){
  if(bgAudio.paused && !muted){ bgAudio.play().catch(()=>{}); }
  // make SFX ready (play/pause quickly to unlock in some browsers)
  Object.values(sfx).forEach(a=>{ a.play().catch(()=>a.pause()); });
  window.removeEventListener('pointerdown', resumeAudio);
}, { once:true });

/* ---------------------------
   Expose some debug helpers to console (optional)
   --------------------------- */
window.__dh = {
  clearWordscapeState,
  clearQuizState,
  clearCaseState,
  saveWordscapeState,
  saveQuizState,
  saveCaseState
};
</script>
</body>
</html> 
